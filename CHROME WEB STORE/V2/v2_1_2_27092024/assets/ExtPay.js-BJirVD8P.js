import{c as B}from"./_commonjsHelpers-C4iS2aBk.js";var F={exports:{}};(function(f,b){(function(p,v){v(f)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:B,function(p){if(!(globalThis.chrome&&globalThis.chrome.runtime&&globalThis.chrome.runtime.id))throw new Error("This script should only be loaded in a browser extension.");if(globalThis.browser&&globalThis.browser.runtime&&globalThis.browser.runtime.id)p.exports=globalThis.browser;else{const v="The message port closed before a response was received.",C=x=>{const _={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(_).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class S extends WeakMap{constructor(r,t=void 0){super(t),this.createItem=r}get(r){return this.has(r)||this.set(r,this.createItem(r)),super.get(r)}}const $=e=>e&&typeof e=="object"&&typeof e.then=="function",h=(e,r)=>(...t)=>{x.runtime.lastError?e.reject(new Error(x.runtime.lastError.message)):r.singleCallbackArg||t.length<=1&&r.singleCallbackArg!==!1?e.resolve(t[0]):e.resolve(t)},k=e=>e==1?"argument":"arguments",E=(e,r)=>function(a,...g){if(g.length<r.minArgs)throw new Error(`Expected at least ${r.minArgs} ${k(r.minArgs)} for ${e}(), got ${g.length}`);if(g.length>r.maxArgs)throw new Error(`Expected at most ${r.maxArgs} ${k(r.maxArgs)} for ${e}(), got ${g.length}`);return new Promise((A,c)=>{if(r.fallbackToNoCallback)try{a[e](...g,h({resolve:A,reject:c},r))}catch(i){console.warn(`${e} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,i),a[e](...g),r.fallbackToNoCallback=!1,r.noCallback=!0,A()}else r.noCallback?(a[e](...g),A()):a[e](...g,h({resolve:A,reject:c},r))})},N=(e,r,t)=>new Proxy(r,{apply(a,g,A){return t.call(g,e,...A)}});let y=Function.call.bind(Object.prototype.hasOwnProperty);const T=(e,r={},t={})=>{let a=Object.create(null),g={has(c,i){return i in e||i in a},get(c,i,u){if(i in a)return a[i];if(!(i in e))return;let l=e[i];if(typeof l=="function")if(typeof r[i]=="function")l=N(e,e[i],r[i]);else if(y(t,i)){let P=E(i,t[i]);l=N(e,e[i],P)}else l=l.bind(e);else if(typeof l=="object"&&l!==null&&(y(r,i)||y(t,i)))l=T(l,r[i],t[i]);else if(y(t,"*"))l=T(l,r[i],t["*"]);else return Object.defineProperty(a,i,{configurable:!0,enumerable:!0,get(){return e[i]},set(P){e[i]=P}}),l;return a[i]=l,l},set(c,i,u,l){return i in a?a[i]=u:e[i]=u,!0},defineProperty(c,i,u){return Reflect.defineProperty(a,i,u)},deleteProperty(c,i){return Reflect.deleteProperty(a,i)}},A=Object.create(e);return new Proxy(A,g)},j=e=>({addListener(r,t,...a){r.addListener(e.get(t),...a)},hasListener(r,t){return r.hasListener(e.get(t))},removeListener(r,t){r.removeListener(e.get(t))}}),L=new S(e=>typeof e!="function"?e:function(t){const a=T(t,{},{getContent:{minArgs:0,maxArgs:0}});e(a)}),w=new S(e=>typeof e!="function"?e:function(t,a,g){let A=!1,c,i=new Promise(M=>{c=function(d){A=!0,M(d)}}),u;try{u=e(t,a,c)}catch(M){u=Promise.reject(M)}const l=u!==!0&&$(u);if(u!==!0&&!l&&!A)return!1;const P=M=>{M.then(d=>{g(d)},d=>{let O;d&&(d instanceof Error||typeof d.message=="string")?O=d.message:O="An unexpected error occurred",g({__mozWebExtensionPolyfillReject__:!0,message:O})}).catch(d=>{console.error("Failed to send onMessage rejected reply",d)})};return P(l?u:i),!0}),R=({reject:e,resolve:r},t)=>{x.runtime.lastError?x.runtime.lastError.message===v?r():e(new Error(x.runtime.lastError.message)):t&&t.__mozWebExtensionPolyfillReject__?e(new Error(t.message)):r(t)},s=(e,r,t,...a)=>{if(a.length<r.minArgs)throw new Error(`Expected at least ${r.minArgs} ${k(r.minArgs)} for ${e}(), got ${a.length}`);if(a.length>r.maxArgs)throw new Error(`Expected at most ${r.maxArgs} ${k(r.maxArgs)} for ${e}(), got ${a.length}`);return new Promise((g,A)=>{const c=R.bind(null,{resolve:g,reject:A});a.push(c),t.sendMessage(...a)})},n={devtools:{network:{onRequestFinished:j(L)}},runtime:{onMessage:j(w),onMessageExternal:j(w),sendMessage:s.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:s.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},o={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return _.privacy={network:{"*":o},services:{"*":o},websites:{"*":o}},T(x,n,_)};p.exports=C(chrome)}})})(F);var m=F.exports;typeof window<"u"&&window.addEventListener("message",f=>{f.origin==="https://extensionpay.com"&&f.source==window&&(f.data==="fetch-user"||f.data==="trial-start")&&m.runtime.sendMessage(f.data)},!1);function U(f){const b="https://extensionpay.com",p=`${b}/extension/${f}`;function v(s){return new Promise(n=>setTimeout(n,s))}async function C(s){try{return await m.storage.sync.get(s)}catch{return await m.storage.local.get(s)}}async function x(s){try{return await m.storage.sync.set(s)}catch{return await m.storage.local.set(s)}}m.management&&m.management.getSelf().then(async s=>{if(!s.permissions.includes("storage")){var n=s.hostPermissions.concat(s.permissions);throw`ExtPay Setup Error: please include the "storage" permission in manifest.json["permissions"] or else ExtensionPay won't work correctly.

You can copy and paste this to your manifest.json file to fix this error:

"permissions": [
    ${n.map(o=>`"    ${o}"`).join(`,
`)}${n.length>0?",":""}
    "storage"
]
`}}),C(["extensionpay_installed_at","extensionpay_user"]).then(async s=>{if(s.extensionpay_installed_at)return;const n=s.extensionpay_user,o=n?n.installedAt:new Date().toISOString();await x({extensionpay_installed_at:o})});const _=[],S=[];async function $(){var s={},n;if(m.management)n=await m.management.getSelf();else if(m.runtime)n=await m.runtime.sendMessage("extpay-extinfo"),n||(n={installType:!("update_url"in m.runtime.getManifest())?"development":"normal"});else throw"ExtPay needs to be run in a browser extension context";n.installType=="development"&&(s.development=!0);const o=await fetch(`${p}/api/new-key`,{method:"POST",headers:{Accept:"application/json","Content-type":"application/json"},body:JSON.stringify(s)});if(!o.ok)throw o.status,`${b}/home`;const e=await o.json();return await x({extensionpay_api_key:e}),e}async function h(){const s=await C(["extensionpay_api_key"]);return s.extensionpay_api_key?s.extensionpay_api_key:null}const k=/^\d\d\d\d-\d\d-\d\dT/;async function E(){var s=await C(["extensionpay_user","extensionpay_installed_at"]);const n=await h();if(!n)return{paid:!1,paidAt:null,installedAt:s.extensionpay_installed_at?new Date(s.extensionpay_installed_at):new Date,trialStartedAt:null};const o=await fetch(`${p}/api/user?api_key=${n}`,{method:"GET",headers:{Accept:"application/json"}});if(!o.ok)throw"ExtPay error while fetching user: "+await o.text();const e=await o.json(),r={};for(var[t,a]of Object.entries(e))a&&a.match&&a.match(k)&&(a=new Date(a)),r[t]=a;return r.installedAt=new Date(s.extensionpay_installed_at),r.paidAt&&(!s.extensionpay_user||s.extensionpay_user&&!s.extensionpay_user.paidAt)&&_.forEach(g=>g(r)),r.trialStartedAt&&(!s.extensionpay_user||s.extensionpay_user&&!s.extensionpay_user.trialStartedAt)&&S.forEach(g=>g(r)),await x({extensionpay_user:e}),r}async function N(){var s=await h();return s||(s=await $()),`${p}?api_key=${s}`}async function y(s,n,o){if(m.windows&&m.windows.create){const e=await m.windows.getCurrent(),r=Math.round((e.width-n)*.5+e.left),t=Math.round((e.height-o)*.5+e.top);try{m.windows.create({url:s,type:"popup",focused:!0,width:n,height:o,left:r,top:t})}catch{m.windows.create({url:s,type:"popup",width:n,height:o,left:r,top:t})}}else window.open(s,null,`toolbar=no,location=no,directories=no,status=no,menubar=no,width=${n},height=${o},left=450`)}async function T(){const s=await N();y(s,500,800)}async function j(s){var n=await h();n||(n=await $());var o=`${p}/trial?api_key=${n}`;s&&(o+=`&period=${s}`),y(o,500,650)}async function L(){var s=await h();s||(s=await $());const n=`${p}/reactivate?api_key=${s}`;y(n,500,800)}var w=!1;async function R(){if(!w){w=!0;for(var s=await E(),n=0;n<2*60;++n){if(s.paidAt)return w=!1,s;await v(1e3),s=await E()}w=!1}}return{getUser:function(){return E()},onPaid:{addListener:function(s){const n=`"content_scripts": [
                {
            "matches": ["${b}/*"],
            "js": ["ExtPay.js"],
            "run_at": "document_start"
        }]`,o=m.runtime.getManifest();if(!o.content_scripts)throw`ExtPay setup error: To use the onPaid callback handler, please include ExtPay as a content script in your manifest.json. You can copy the example below into your manifest.json or check the docs: https://github.com/Glench/ExtPay#2-configure-your-manifestjson

        ${n}`;const e=o.content_scripts.find(r=>r.matches.includes(b.replace(":3000","")+"/*"));if(e){if(!e.run_at||e.run_at!=="document_start")throw`ExtPay setup error: To use the onPaid callback handler, please make sure the ExtPay content script in your manifest.json runs at document start. You can copy the example below into your manifest.json or check the docs: https://github.com/Glench/ExtPay#2-configure-your-manifestjson

        ${n}`}else throw`ExtPay setup error: To use the onPaid callback handler, please include ExtPay as a content script in your manifest.json matching "${b}/*". You can copy the example below into your manifest.json or check the docs: https://github.com/Glench/ExtPay#2-configure-your-manifestjson

        ${n}`;_.push(s)}},openPaymentPage:T,openTrialPage:j,openLoginPage:L,onTrialStarted:{addListener:function(s){S.push(s)}},startBackground:function(){m.runtime.onMessage.addListener(function(s,n,o){if(console.log("service worker got message! Here it is:",s),s=="fetch-user")R();else if(s=="trial-start")E();else if(s=="extpay-extinfo"&&m.management)return m.management.getSelf()})}}}export{U as default};
